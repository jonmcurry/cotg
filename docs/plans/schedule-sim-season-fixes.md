# Schedule and Sim Season Fixes Plan

## Issues Reported

### Issue 1: Teams playing same opponent 3 times in a row
- **Symptom**: Recent results showed teams playing same opponent 3 consecutive games
  - e.g., Asheville Dragoons vs Durham Marauders x3
  - e.g., Nashville Voyagers vs Tulsa Pioneers x3
- **Root Cause**: Backend schedule generator was using OLD series-based format
  - Frontend `scheduleGenerator.ts` had the correct circle method
  - But schedule is generated by backend API (`/api/draft/sessions/:id/schedule`)
  - Backend `schedule.ts` still used 2-4 game series with random shuffling

### Issue 2: Sim Season stops at All-Star game
- **Symptom**: User clicks Sim Season, it stops at All-Star game mid-season
- **Root Cause**: Sim Season button was disabled when `isNextGameAllStar` was true
  - User had to manually click "Play All-Star Game" button
  - After that, simulation could continue
  - UX issue: Sim Season should handle this automatically

## Investigation (TDD Approach)

### Tests Written
Created `tests/scheduleIssues.test.ts`:
1. Circle method should NOT have same matchup on day 7 and day 8
2. No team plays same opponent on ANY consecutive days
3. 16-team league also has no consecutive same-opponent games

Frontend schedule generator passed all tests, confirming the bug was in backend.

## Fixes Applied

### Fix 1: Backend Schedule Generator
**File**: `backend/src/routes/schedule.ts`

Rewrote to use circle method:
- Added `generateDayMatchupsCircle()` function
- Fixed team at position 0, rotate all others
- Pairs teams from outside-in
- Home/away tracking with per-matchup and global balance

Key changes:
- Removed `distributeIntoSeries()` function
- Removed series-based game generation
- Added daily format with circle method rotation

### Fix 2: Sim Season All-Star Handling
**File**: `src/components/statmaster/StatMaster.tsx`

Modified `handleSimulateSeason()`:
- Check if All-Star game is next and not played
- Auto-play it using existing `selectAllStarRosters` and `simulateAllStarGame`
- Update state with rosters and result
- Continue simulating remaining regular games

Also removed `isNextGameAllStar` check from Sim Season button disabled condition.

## Verification

- [x] Frontend TypeScript compiles without errors
- [x] Backend TypeScript compiles without errors
- [x] Frontend builds successfully
- [x] Backend builds successfully
- [x] All scheduleAndSeason tests pass (10/10)
- [x] All scheduleIssues tests pass (3/3)

## Files Changed
- `backend/src/routes/schedule.ts` - Complete rewrite to circle method
- `src/components/statmaster/StatMaster.tsx` - Auto All-Star game handling
- `tests/scheduleIssues.test.ts` - New TDD test file

## Note
After this fix, users need to generate a NEW schedule to see the daily format.
Existing schedules with the old series format will not be automatically fixed.
